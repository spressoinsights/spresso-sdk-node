name: CI
on:
    push:
      branches:
        - development
        - main
    pull_request:
      branches:
        - main
        - development
jobs:
    e2eTesting:
        runs-on: ubuntu-latest
        name: E2E Testing
        steps:
            - uses: actions/checkout@v3
            - name: Start minikube
              uses: medyagh/setup-minikube@master
            - name: Install Nix Package Manager
              uses: cachix/install-nix-action@v18
              with:
                  nix_path: nixpkgs=channel:nixos-22.05
            - name: Deploy to minikube
              run: nix-shell --command "make -f ./commands.nixwrap startE2EServicesCI"
            - name: Log Minikube Deployed Services
              run: kubectl describe Pod verdaccio
            - name: Install
              run: nix-shell --command "make -f ./commands.nixwrap install"
            - name: Local Publish
              run: nix-shell --command "make -f ./commands.nixwrap localPublish"
            - name: E2E Testing
              env:
                CLIENTSECRET: ${{ secrets.CLIENTSECRET }}
              run: |
                  nix-shell --command "make -f ./commands.nixwrap installForE2ETesting"
                  nix-shell --command "make -f ./commands.nixwrap e2eTesting"
    unitTesting:
        runs-on: ubuntu-latest
        name: Unit Testing
        steps:
            - uses: actions/checkout@v3
            - name: Install Nix Package Manager
              uses: cachix/install-nix-action@v18
              with:
                  nix_path: nixpkgs=channel:nixos-22.05
            - name: Install & Bootstrap
              run: nix-shell --command "make -f ./commands.nixwrap bootstrap"
            - name: Build
              run: nix-shell --command "make -f ./commands.nixwrap build"
            - name: Unit Testing
              run: nix-shell --command "make -f ./commands.nixwrap unitTesting"
    integrationTesting:
        runs-on: ubuntu-latest
        name: Integration Testing
        steps:
            - uses: actions/checkout@v3
            - name: Start minikube
              uses: medyagh/setup-minikube@master
            - name: Install Nix Package Manager
              uses: cachix/install-nix-action@v18
              with:
                  nix_path: nixpkgs=channel:nixos-22.05
            - name: Deploy to minikube
              run: nix-shell --command "make -f ./commands.nixwrap startIntegrationServicesCI"
            - name: Log Minikube Deployed Services
              run: kubectl describe Pod redis6
            - name: Install & Bootstrap
              run: nix-shell --command "make -f ./commands.nixwrap bootstrap"
            - name: Build
              run: nix-shell --command "make -f ./commands.nixwrap build"
            - name: Integration Testing
              run: nix-shell --command "make -f ./commands.nixwrap integrationTesting"
